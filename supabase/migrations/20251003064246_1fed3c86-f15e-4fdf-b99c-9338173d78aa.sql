-- Create enum for user roles
CREATE TYPE public.app_role AS ENUM ('admin', 'corretor');

-- Create profiles table
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT NOT NULL,
  whatsapp TEXT NOT NULL,
  avatar_url TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create user_roles table
CREATE TABLE public.user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  role app_role NOT NULL,
  UNIQUE (user_id, role)
);

-- Create messages table
CREATE TABLE public.messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  funnel TEXT NOT NULL,
  stage TEXT NOT NULL,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  likes INTEGER DEFAULT 0,
  dislikes INTEGER DEFAULT 0,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create user_message_feedback table
CREATE TABLE public.user_message_feedback (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  message_id UUID REFERENCES public.messages(id) ON DELETE CASCADE NOT NULL,
  feedback_type TEXT CHECK (feedback_type IN ('like', 'dislike', 'copy')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE (user_id, message_id, feedback_type)
);

-- Create suggestions table
CREATE TABLE public.suggestions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE NOT NULL,
  message_id UUID REFERENCES public.messages(id) ON DELETE CASCADE NOT NULL,
  suggestion_text TEXT NOT NULL CHECK (char_length(suggestion_text) <= 200),
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create resources table for Central de Recursos
CREATE TABLE public.resources (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  description TEXT,
  resource_type TEXT NOT NULL CHECK (resource_type IN ('pdf', 'link', 'video')),
  url TEXT NOT NULL,
  display_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_message_feedback ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.suggestions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.resources ENABLE ROW LEVEL SECURITY;

-- Create security definer function to check roles
CREATE OR REPLACE FUNCTION public.has_role(_user_id UUID, _role app_role)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = _user_id AND role = _role
  )
$$;

-- RLS Policies for profiles
CREATE POLICY "Users can view all profiles" ON public.profiles FOR SELECT USING (true);
CREATE POLICY "Users can update own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can insert own profile" ON public.profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- RLS Policies for user_roles
CREATE POLICY "Users can view all roles" ON public.user_roles FOR SELECT USING (true);
CREATE POLICY "Only admins can manage roles" ON public.user_roles FOR ALL USING (public.has_role(auth.uid(), 'admin'));

-- RLS Policies for messages
CREATE POLICY "Everyone can view messages" ON public.messages FOR SELECT USING (true);
CREATE POLICY "Only admins can manage messages" ON public.messages FOR ALL USING (public.has_role(auth.uid(), 'admin'));

-- RLS Policies for user_message_feedback
CREATE POLICY "Users can view own feedback" ON public.user_message_feedback FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own feedback" ON public.user_message_feedback FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Admins can view all feedback" ON public.user_message_feedback FOR SELECT USING (public.has_role(auth.uid(), 'admin'));

-- RLS Policies for suggestions
CREATE POLICY "Users can view own suggestions" ON public.suggestions FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own suggestions" ON public.suggestions FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Admins can view all suggestions" ON public.suggestions FOR SELECT USING (public.has_role(auth.uid(), 'admin'));
CREATE POLICY "Admins can update suggestions" ON public.suggestions FOR UPDATE USING (public.has_role(auth.uid(), 'admin'));

-- RLS Policies for resources
CREATE POLICY "Everyone can view resources" ON public.resources FOR SELECT USING (true);
CREATE POLICY "Only admins can manage resources" ON public.resources FOR ALL USING (public.has_role(auth.uid(), 'admin'));

-- Create function to handle new user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE PLPGSQL
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, whatsapp)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'full_name', 'Usu√°rio'),
    COALESCE(NEW.raw_user_meta_data->>'whatsapp', '')
  );
  
  -- Assign corretor role by default
  INSERT INTO public.user_roles (user_id, role)
  VALUES (NEW.id, 'corretor');
  
  RETURN NEW;
END;
$$;

-- Create trigger for new user
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Create function to update updated_at
CREATE OR REPLACE FUNCTION public.update_updated_at()
RETURNS TRIGGER
LANGUAGE PLPGSQL
AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$;

-- Create triggers for updated_at
CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON public.profiles
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

CREATE TRIGGER update_messages_updated_at BEFORE UPDATE ON public.messages
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

CREATE TRIGGER update_resources_updated_at BEFORE UPDATE ON public.resources
  FOR EACH ROW EXECUTE FUNCTION public.update_updated_at();

-- Insert initial messages from the current INITIAL_MESSAGES
INSERT INTO public.messages (funnel, stage, title, content, likes, dislikes, display_order) VALUES
-- Abordagem ‚Äì Lead Novo
('lead-novo', '1¬™ Abordagem', 'Sauda√ß√£o Inicial', 'üëã Oi [NOME]! Tudo bem? Vi que voc√™ demonstrou interesse em im√≥veis aqui em Itapema. Sou [CORRETOR], conselheiro da COMARC. Posso te ajudar a encontrar a op√ß√£o que mais combina com o que voc√™ procura?', 45, 3, 1),
('lead-novo', '2¬™ Abordagem', 'Confirma√ß√£o de Recebimento', 'üëã Oi [NOME], tudo bem? S√≥ passando pra confirmar se voc√™ recebeu as informa√ß√µes sobre o [EMPREENDEDIMENTO]. Quer que eu te envie os detalhes ou as fotos?', 38, 5, 2),
('lead-novo', '3¬™ Abordagem', 'Objetivo do Cliente', 'üëã Oi [NOME], notei que voc√™ demonstrou interesse no [EMPREENDEDIMENTO]. Est√° buscando algo pra morar ou investir?', 52, 2, 3),
('lead-novo', '4¬™ Abordagem', 'Resumo R√°pido', 'üëã [NOME], tudo bem? Vi que ainda n√£o conseguimos falar. Quer que eu te mande um resumo r√°pido do [EMPREENDEDIMENTO]?', 29, 8, 4),
('lead-novo', '5¬™ Abordagem', 'Condi√ß√µes Especiais', 'üëã Oi [NOME], passando pra avisar que ainda temos boas condi√ß√µes no [EMPREENDEDIMENTO]. Posso te enviar um comparativo de valores?', 41, 4, 5),
('lead-novo', '6¬™ Abordagem', 'Dia a Dia Corrido', 'üëã [NOME], sei que o dia a dia √© corrido. S√≥ pra n√£o perder a chance: ainda tem interesse no [EMPREENDEDIMENTO]?', 33, 6, 6),
('lead-novo', '7¬™ Abordagem', '√öltimo Contato', 'üëã Oi [NOME], √∫ltima vez que entro em contato pra n√£o te incomodar üôÇ Quer que eu te mostre as condi√ß√µes atuais do [EMPREENDEDIMENTO]?', 27, 9, 7),

-- Atendimento Geral - Sondagem
('atendimento', 'Sondagem', 'Objetivo da Compra', 'üëã Oi [NOME]! Vi que voc√™ pediu infos do [EMPREENDEDIMENTO]. Pra eu te ajudar melhor: voc√™ pensa em comprar pra morar ou pra investir?', 67, 1, 1),
('atendimento', 'Sondagem', 'Localiza√ß√£o Atual', 'Entendi üëç E hoje voc√™ j√° mora na regi√£o ou est√° pensando em vir pra c√°?', 54, 3, 2),
('atendimento', 'Sondagem', 'Prioridades', 'Legal! O que mais √© importante pra voc√™ nesse novo im√≥vel? (ex.: vista, lazer, n¬∫ de su√≠tes, localiza√ß√£o‚Ä¶)', 61, 2, 3),
('atendimento', 'Sondagem', 'Prefer√™ncia de Regi√£o', 'Tem alguma regi√£o ou bairro que voc√™ prefira?', 48, 4, 4),
('atendimento', 'Sondagem', 'N√∫mero de Quartos', 'Quantos quartos voc√™ imagina que precisa pra ficar confort√°vel?', 52, 2, 5),
('atendimento', 'Sondagem', 'Faixa de Valor', 'Pra eu te mostrar as op√ß√µes certas, tem uma faixa de valor que voc√™ est√° pensando?', 44, 8, 6),
('atendimento', 'Sondagem', 'Prazo', 'Existe algum prazo ou data importante pra essa compra?', 39, 5, 7),
('atendimento', 'Sondagem', 'Transi√ß√£o para Envio', 'Perfeito. Com base nisso, posso te enviar 2 op√ß√µes alinhadas ao que voc√™ busca. Quer que eu te envie agora?', 73, 1, 8),

-- Atendimento Geral - Apresenta√ß√£o do Produto
('atendimento', 'Apresenta√ß√£o do Produto', 'Primeiro Envio de Op√ß√µes', 'üëã [NOME], com base no que voc√™ me contou, separei duas op√ß√µes que acredito que podem encaixar muito bem no que voc√™ busca. Quer que eu te envie as fotos e detalhes pra dar uma olhada?', 68, 2, 1),
('atendimento', 'Apresenta√ß√£o do Produto', 'Envio com Benef√≠cio Destacado', 'üëã [NOME], encontrei uma op√ß√£o que acho que vai te surpreender. O [EMPREENDEDIMENTO] tem [CARACTER√çSTICA CHAVE: ex. vista para o mar, lazer completo, √≥tima valoriza√ß√£o] e est√° com condi√ß√£o especial no momento. Quer que eu te envie as plantas e os valores?', 71, 3, 2),
('atendimento', 'Apresenta√ß√£o do Produto', 'Envolvendo o Cliente na Escolha', 'üëã [NOME], selecionei algumas op√ß√µes de acordo com o que conversamos. Quer que eu te envie primeiro as que t√™m [DIFERENCIAL: ex. maior √°rea de lazer, unidades com vista, pronto para morar] ou prefere ver as que t√™m o melhor custo-benef√≠cio?', 59, 4, 3),
('atendimento', 'Apresenta√ß√£o do Produto', 'Refor√ßo de Escassez', 'üëã [NOME], as √∫ltimas unidades do [EMPREENDEDIMENTO] est√£o com condi√ß√£o especial e acredito que valem a pena conhecer. Quer que eu te envie as informa√ß√µes antes que as melhores unidades sejam vendidas?', 64, 5, 4),

-- Atendimento Geral - Visita / Call
('atendimento', 'Visita / Call', 'Agendar Reuni√£o Online', 'üëã [NOME], podemos agendar uma reuni√£o online pra te apresentar melhor o [EMPREENDEDIMENTO] e tirar todas as d√∫vidas? Tenho disponibilidade [DIA/HORA].', 76, 2, 1),
('atendimento', 'Visita / Call', 'Call R√°pida', 'üëã [NOME], que tal fazermos uma call r√°pida pra te mostrar os detalhes do [EMPREENDEDIMENTO]? √â bem pr√°tico e voc√™ consegue ver tudo sem sair de casa.', 69, 4, 2),

-- Atendimento Geral - Proposta
('atendimento', 'Proposta', 'Abertura Consultiva', 'üëã [NOME], com base na unidade que voc√™ mais gostou, j√° conseguimos calcular as condi√ß√µes ideais. Quer que eu te envie a proposta pra analisarmos juntos?', 72, 3, 1),
('atendimento', 'Proposta', 'Proposta com Urg√™ncia', 'üëã [NOME], a condi√ß√£o especial que comentei est√° garantida at√© [DATA]. Quer que eu te envie a proposta detalhada pra avaliarmos e garantir essa condi√ß√£o?', 65, 6, 2),
('atendimento', 'Proposta', 'Oportunidade de Investimento', 'üëã [NOME], com a valoriza√ß√£o prevista pra regi√£o e a condi√ß√£o que conseguimos, acredito que essa proposta do [EMPREENDEDIMENTO] est√° muito vantajosa. Quer dar uma olhada agora pra ver os n√∫meros?', 70, 4, 3),
('atendimento', 'Proposta', 'Foco em Seguran√ßa', 'üëã [NOME], j√° deixei a proposta pronta e podemos revisar juntos na call. Assim consigo te mostrar cada detalhe e esclarecer d√∫vidas na hora. Que dia/hora √© melhor pra voc√™?', 68, 5, 4),

-- Atendimento Geral - Fechamento
('atendimento', 'Fechamento', 'Urg√™ncia Comercial', 'üëã [NOME], s√≥ confirmando: conseguimos manter aquela condi√ß√£o especial at√© [DATA]. Quer aproveitar e garantir a unidade antes que o pre√ßo mude?', 58, 7, 1),
('atendimento', 'Fechamento', 'Exclusividade / Escassez', 'üëã [NOME], as unidades do [EMPREENDEDIMENTO] com as melhores condi√ß√µes est√£o quase esgotando. Se quiser garantir a sua com essa condi√ß√£o, consigo reservar pra voc√™ at√© [DATA].', 64, 5, 2),
('atendimento', 'Fechamento', 'Oportunidade de Investimento', 'üëã [NOME], essa condi√ß√£o do [EMPREENDEDIMENTO] √© muito rara pra im√≥veis nessa regi√£o. Podemos fechar at√© [DATA] pra voc√™ n√£o perder a valoriza√ß√£o que vem por a√≠.', 61, 6, 3),

-- Repescagem
('repescagem', 'Reativa√ß√£o', 'Retomada de Contato', 'üëã Oi [NOME], aqui √© o [CORRETOR] da COMARC. Vi que voc√™ pediu informa√ß√µes sobre o [EMPREENDEDIMENTO] um tempo atr√°s. Chegou a encontrar algo que gostou ou ainda est√° avaliando op√ß√µes?', 34, 9, 1),
('repescagem', 'Reativa√ß√£o', 'Novidade Relevante', 'üëã [NOME], tudo bem? S√≥ queria saber se voc√™ continua interessado em im√≥veis na regi√£o de [CIDADE]. Tem um detalhe novo no [EMPREENDEDIMENTO] que acho que pode te interessar. Quer que eu te conte?', 41, 6, 2),
('repescagem', 'Reativa√ß√£o', 'Condi√ß√£o Especial', 'üëã Oi [NOME], aqui √© o [CORRETOR]. Sei que voc√™ j√° recebeu contatos antes, mas queria te atualizar: temos uma condi√ß√£o especial no [EMPREENDEDIMENTO] v√°lida por poucos dias. Posso te enviar agora?', 38, 7, 3),

-- Nutri√ß√£o - Educa√ß√£o
('nutricao', 'Educa√ß√£o', 'Valoriza√ß√£o da Regi√£o', 'üëã Oi [NOME], compartilho essa novidade: [LINK]. √â sobre a valoriza√ß√£o da regi√£o de [CIDADE]/[BAIRRO]. Achei que poderia te interessar.', 28, 4, 1),
('nutricao', 'Educa√ß√£o', 'Dados de Mercado', 'üëã [NOME], sabia que [CIDADE] teve valoriza√ß√£o m√©dia de X% no √∫ltimo ano? Isso refor√ßa as oportunidades de investimento. Se quiser, te mostro algumas op√ß√µes.', 36, 3, 2),

-- Nutri√ß√£o - Oportunidades
('nutricao', 'Oportunidades', 'Novo Empreendimento', 'üëã Oi [NOME], saiu um novo empreendimento em [BAIRRO], com perfil parecido ao que voc√™ buscou. Quer dar uma olhada r√°pida nas plantas?', 42, 5, 1);

-- Create storage bucket for avatars
INSERT INTO storage.buckets (id, name, public) VALUES ('avatars', 'avatars', true);

-- Storage policies for avatars
CREATE POLICY "Avatar images are publicly accessible" ON storage.objects FOR SELECT USING (bucket_id = 'avatars');
CREATE POLICY "Users can upload their own avatar" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'avatars' AND auth.uid()::text = (storage.foldername(name))[1]);
CREATE POLICY "Users can update their own avatar" ON storage.objects FOR UPDATE USING (bucket_id = 'avatars' AND auth.uid()::text = (storage.foldername(name))[1]);
CREATE POLICY "Users can delete their own avatar" ON storage.objects FOR DELETE USING (bucket_id = 'avatars' AND auth.uid()::text = (storage.foldername(name))[1]);